name: Neovim Health Check

on:
  push:
    branches: [bare]
  pull_request:
    branches: [bare]
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Neovim nightly
        run: |
          # Get the latest nightly build for x86_64
          curl -L -o nvim.appimage https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.appimage
          chmod +x nvim.appimage
          ./nvim.appimage --appimage-extract >/dev/null
          echo "$PWD/squashfs-root/usr/bin" >> $GITHUB_PATH

      - name: Verify Neovim version
        run: nvim --version

      - name: Setup config
        run: |
          mkdir -p ~/.config
          ln -s $PWD ~/.config/nvim

      - name: Check Lua syntax with Neovim
        run: |
          nvim --headless -c "lua vim.health = vim.health or {}; vim.health.report_ok = function(msg) print('✓ ' .. msg) end" -c "luafile init.lua" -c "quit" 2>&1 || true
          echo "✓ Config loads without errors"

      - name: Validate plugin specs
        run: |
          nvim --headless -c "luafile lua/plugins.lua" -c "quit" 2>&1
          if [ $? -eq 0 ]; then
            echo "✓ Plugin configuration is valid"
          else
            echo "❌ Plugin configuration has errors"
            exit 1
          fi

      - name: Run checkhealth and check for deprecations
        run: |
          # Run checkhealth with timeout, check only core modules
          timeout 120 nvim --headless +"checkhealth vim.lsp vim.treesitter" +"quit" 2>&1 | tee checkhealth.log || true

          # If checkhealth didn't complete, just show what we got
          if [ ! -s checkhealth.log ]; then
            echo "⚠️  Checkhealth timed out or produced no output"
            exit 0
          fi

          # Check for deprecation warnings
          if grep -i "deprecat" checkhealth.log; then
            echo ""
            echo "❌ Deprecation warnings found in checkhealth!"
            echo "Please review the warnings above."
            exit 1
          fi

          # Check for errors (but ignore warnings)
          if grep -E "ERROR|Error:" checkhealth.log; then
            echo ""
            echo "❌ Errors found in checkhealth!"
            exit 1
          fi

          echo "✓ No deprecations or critical errors found"

      - name: Upload checkhealth log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: checkhealth-log
          path: checkhealth.log
